clear all;

S = [0.151
0.050
0.050
-0.352
-0.303
0.101
0.000
-0.202
-0.051
0.811
-0.805
0.254
1.366
0.599
1.042
-0.393
-0.444
-0.941
-0.300
0.802
0.099
0.845
0.246
1.425
-0.436
1.703
-0.335
0.144
0.384
0.525
2.375
0.139
0.093
0.046
0.694
-1.608
-0.374
-0.891
0.757
-0.939
0.095
0.142
0.615
0.000
0.705
0.467
-1.486
-23.574
-24.676
-24.570
-13.355
18.797
15.823
-4.463
-14.013
-6.208
-17.730
-18.678
-17.668
0.000
-3.648
-1.559
-18.100
-6.906
0.890
23.529
19.048
-10.000
11.556
-0.398
-6.200
-0.426
-4.283
-0.447
-4.944
-4.492
8.416
-2.740
-3.286
3.155
0.235
6.808
3.077
3.198
8.471
-8.762
-5.428
-7.285
-9.524
2.368
-7.969
2.514
-8.992
-0.299
-5.405
2.222
-0.311
1.558
-2.761
-5.678
2.007
-6.230
-27.622
4.348
-7.407
-4.000
-1.042
4.737
25.126
32.129
-2.736
-5.625
3.974
-2.866
0.328
-4.248
5.119
2.597
0.000
2.848
0.308
0.613
19.817
5.089
0.969
-3.357
1.985
7.299
-0.454
2.050
3.795
2.581
0.419
6.263
15.914
-7.966
-1.473
-4.299
-15.820
4.872
-5.973
5.176
0.671
-3.333
-5.747
0.000
-5.122
0.000
15.424
-2.450
-0.913
1.152
-3.189
1.412
-0.232
-0.930
0.235
-2.108
-7.656
-4.663
8.696
-1.250
-1.519
-0.771
0.259
-0.258
-1.813
1.319
1.563
1.538
-0.505
-4.569
-5.319
1.685
-1.657
-5.899
-8.060
0.000
-2.922
-13.378
-6.178
8.230
-11.407
3.004
-0.417
-3.766
-11.739
3.941
4.265
3.636
-5.702
0.930
0.922
-0.457
-0.917
-0.463
35.814
-9.932
7.985
10.915
1.587
-4.375
-2.614
-4.027
8.392
-2.581
-0.662
6.333
-7.837
1.701
-3.010
0.345
4.467
-0.987
-2.326
-1.701
1.038
-5.822
2.182
-3.559
4.059
-0.709
0.000
1.429
0.000
-0.352
-0.353
-1.773
-0.722
-11.273
1.230
-4.453
-0.424
-0.851
-3.004
1.327
0.437
1.739
-9.829
5.213
-4.054
-0.939
-11.848
-2.151
0.549];

% Step 0. Set initial values and parameters
% S = [4.4; 4.0; 3.5; 4.6];
% a0 = 4;
% Sig0 = 12;
% sige = 1;
% sigeps = 2;
a0 = 0;
Sig0 = 100;
T = 0.3274
sige = 4.155;
sigeps = 5.901;

N = size(S,1);
a_fore = zeros(N,1);
Sig_fore = zeros(N,1);
nu = zeros(N,1);
F = zeros(N,1);
K = zeros(N,1);
a_filt = zeros(N,1);
Sig_filt = zeros(N,1);

a_filt_prev = a0;
Sig_filt_prev = Sig0;
for t = 1:N
    a_fore(t) = T*a_filt_prev;
    Sig_fore(t) = T^2*Sig_filt_prev + sigeps^2;
    nu(t) = S(t) - a_fore(t);
    K(t) = Sig_fore(t)/(Sig_fore(t) + sige^2);
    a_filt(t) = a_fore(t) + K(t)*nu(t);
    Sig_filt(t) = (1-K(t))*Sig_fore(t);
    a_filt_prev = a_filt(t);
    Sig_filt_prev = Sig_filt(t);
end

figure;
subplot(221);
plot(S);
hold on;
plot(a_fore);
legend('actual','forecast');
subplot(222);
plot(nu);
subplot(223);
plot(S);
hold on;
plot(a_filt);
legend('actual','filtered');
subplot(224);
plot(a_filt);
hold on;
plot(a_filt+2*sqrt(Sig_filt))
plot(a_filt-2*sqrt(Sig_filt))
    

